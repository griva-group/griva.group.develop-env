# [GGDDEnv] Установка решения

## Оглавление

- [Подготовительный этап](#prepare)
- [Первый этап: создание контейнера http-сервера](#first)
- [Создание удобной рабочей среды средствами DNS-proxy на локальной машине](#localdns)
- [Заключенне](#final)

## <a name="prepare"></a>Подготовительный этап

### Создание виртуальной сети

Первым дествием нужно склонировать репозиторий в какую-либо директоию.
Желательно, что бы директория была пустой/новой. В качестве рекомендации
предлагаю размещать в директории `/var/containers`, что бы избежать
двусмысленности.

После, мы должны создать виртуальную локальную сеть для контейнеров следующей
командой:

```bash
docker network create ggenv.network
```

Это необходимо, потому что без нее мы не сможем создать гибкую систему, которая
смогла бы поддерживать несколько виртуальных хостов.

## <a name="first"></a>Первый этап: создание контейнера http-сервера

Здесь важно понимать, что контейнеры http-серверов поднимаются в единственном
экземпляре на все виртуальные хосты, поэтому необходимо сразу представлять
какую структуру мы хотим создать. Сейчас подготовлены два образа: nginx и
apache2. Есть возможность использовать их как независимые http-сервера, а так
же static+backend. Т.к. вся конфигурация виртуальных хостов находятся в
директориях проектов, то мы можем создать либо один из контейнеров любого
http-сервера, либо оба.

*При создании контейнеров на ОС Windows, необходимо ```$(pwd)``` заменить на
```%cd%```, а при использовании PowerShell оболочки, необходимо избавиться от
кавычек и заменить на ```${PWD}```*

### Создание, запуск и другие дествия с контейнером nginx

Базовая конфигурация контейнера поддерживает скнирование директорий проекта на
наличие специального файла `%PROJECT_ROOT%/env/*/etc/nginx/live.nginx.conf`.
В нем описывается конфигурация конерктного виртуального хоста. Для обглечения,
в тестовом проекте, указаны варианты использования с PHP как http-сервера и
использования в режиме reverse proxy.

```smartyconfig
# IF NGIX AS BACKEND
# ...

# IF NGIX AS PROXY
# ...
```

Создание нового образа и первого запуска контейенра происходит следующими
командами. Они выполняются один раз, только при установке этого решения.

```bash
docker build --tag=ggenv.nginx --file=./webserver/Dockerfile.nginx ./webserver
docker run -d \
    -p 80:80 \
    -v "$(pwd)/projects":/var/www:rw,cached \
    --network ggenv.network \
    --name ggenv.nginx ggenv.nginx
```

Ниже представлены комманды управления созданным контейнером и другими операциями
над ним. Данные команды могут исполнятся в любой директории.

```bash
# Запуск контейнера nginx
docker start ggenv.nginx

# Принудительная остановка контейнера nginx
docker stop -t 5 ggenv.nginx

# Мягкая перезагрузка конфигурации nginx
docker exec -ti ggenv.nginx nginx -s reload

# Войти в интерактивную оболочку контейнера nginx
docker exec -ti ggenv.nginx /bin/bash

# Просмотр логов в реальном времени
docker logs -f ggenv.nginx
```

### Создание, запуск и другие дествия с контейнером apache2

Конфигурация контейнера настройена для работы с php-fpm контейенром. Определение
рабочей директории и других сайтоспецифичных параметров находятся через
вычисление по домену. Префикс www. искуственно вырезается (пример:
`www.sample.vhost` => `%PROJECTS_ROOT%/sample.vhost`).

Создание нового образа и первого запуска контейенра происходит следующими
командами. Они выполняются один раз, только при установке этого решения.
Единственная переменная, это пробрасываемый порт при первом запуске контейнера
`docker run -p`. Если вы хотите, что бы apache2 работал, как единственный
http-сервер, а не backend, то необходимо заменить `-p 8080:80` на `-p 80:80`.
При этом, nginx контейнер не должен быть запущен.

```bash
docker build --tag=ggenv.httpd --file=./webserver/Dockerfile.httpd ./webserver
docker run -d \
    -p 8080:80 \
    -v "$(pwd)/projects":/var/www:rw,cached \
    --network ggenv.network \
    --name ggenv.httpd ggenv.httpd
```

Ниже представлены комманды управления созданным контейнером и другими операциями
над ним. Данные команды могут исполнятся в любой директории.

```bash
# Запуск контейнера apache2
docker start ggenv.httpd

# Принудительная остановка контейнера apache2
docker stop -t 5 ggenv.httpd

# Перезагрузка конфигурации apache2
docker restart ggenv.httpd

# Войти в интерактивную оболочку контейнера apache2
docker exec -ti ggenv.httpd /bin/bash

# Просмотр логов в реальном времени
docker logs -f ggenv.httpd
```

## <a name="loacldns"></a>Создание удобной рабочей среды средствами DNS-proxy на локальной машине

Для удобного доступа к проектам убедительно рекомендуется создавать локальные
домены с доменом верхнего уровня *.vhost.

1. Для **\*nix** системам все довольно просто и обкатано: необходимо установить
программу dnsmasq и настроить по данной инструкции

    - **macOS** - https://gist.github.com/ogrrd/5831371
    - **Linux** - *еще не найдено*

2. Для **Windows** - https://github.com/stackia/DNSAgent 

## <a name="final"></a>Закючение

После выполнения данных этапов вы сможете зайти  по ссылке <http://localhost>,
где должны увидеть стандартную html-заглушку.

Будьте внимательны. В случае отключения сервиса docker или его непредвиденного
завершения скрипты плавного отключения контейнеров не отрабатывают. Из-за этого
контейнер http-сервера не может стратовать в последствии, потому что пытается
пропинговать несуществующие сокеты. Что бы решить возникшую ситуацию - удалите
автоматически сгенерированные файлы nginx-конфигурации
(```/var/www/%project_name%/env/php/etc/nginx/live.nginx.conf```).
